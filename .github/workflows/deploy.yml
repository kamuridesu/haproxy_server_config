name: CD
on: [push, workflow_dispatch]
jobs:
  test:
    name: Test configuration file
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && 'refs/head/main'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: Test files
        run: |
          ouptut=$(docker run -it --rm --name haproxy-syntax-check -v $(pwd):/usr/local/etc/haproxy haproxy haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg)
          echo $output | grep "Configuration file is valid" || /bin/false

  deploy:
    name: Apply changes to the server
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && 'refs/head/main'
    steps:
      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/aws
          chmod 600 ~/.ssh/aws
          cat >>~/.ssh/config <<END
          Host kamuridesu.tech
            HostName kamuridesu.tech
            User admin
            IdentityFile ~/.ssh/aws
            StrictHostKeyChecking no
          END
        env:
            SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        
      - name: Clone or update repository
        run: ssh admin@kamuridesu.tech "cd ${{ github.event.repository.name }} && git pull || git clone https://github.com/${{ github.repository }}.git"
      - name: Put files on server
        run: |
          ssh admin@kamuridesu.tech "USERNAME=${{ secrets.USERNAME }}; PASSWORD=${{ secrets.PASSWORD }}; sudo cat ${{ github.event.repository.name }}/haproxy.cfg | envsubst > /etc/haproxy/haproxy.cfg"
      - name: Restart HAproxy
        run: sudo /etc/init.d/haproxy restart
